{% extends 'layout.html' %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-4">
            <div class="card shadow my-4">
                <div class="card-body">
                    <form id="form">
                        <div class="form-group">
                            <label for="data">Data</label>
                            <input id="data" name="data" class="form-control" type="month" />
                        </div>
                        <button type="submit" class="btn btn-primary">Listar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow my-4">
        <div class="card-body" id="div-grafico">
            <!-- O gráfico será gerado aqui -->
        </div>
    </div>
</div>

<script type="text/javascript" src="/static/js/chart.js/chart.min.js"></script>

<script type="text/javascript">
    "use strict";

    // Validação e envio do formulário
    document.getElementById("form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const dataSelecionada = document.getElementById("data").value;

        if (!dataSelecionada) {
            alert("Por favor, selecione uma data.");
            return;
        }

        // Extraindo o ano e o mês
        const mes = dataSelecionada.split("-")[1]; // Pega o mês do formato "YYYY-MM"
        const ano = dataSelecionada.split("-")[0]; // Pega o ano do formato "YYYY-MM"

        // Chamando a API
        await atualizarDados(ano, mes);
    });

    async function atualizarDados(ano, mes) {
        try {
            const response = await fetch(`/listar-consolidado-dia-mes?ano=${ano}&mes=${mes}`);
            if (!response.ok) {
                alert("Erro ao carregar os dados.");
                return;
            }

            const dados = await response.json();

            if (!dados.length) {
                alert("Nenhum dado disponível para o período selecionado.");
                return;
            }

            // Preparar dados para o gráfico
            const labels = dados.map(item => item.dia);
            const valores = dados.map(item => item.consumo);

            // Renderizar o gráfico
            const canvas = document.createElement("canvas");
            const divGrafico = document.getElementById("div-grafico");
            divGrafico.innerHTML = "";
            divGrafico.appendChild(canvas);

            new Chart(canvas, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Consumo por Dia (kWh)",
                        data: valores,
                        backgroundColor: "rgba(54, 162, 235, 0.5)",
                        borderColor: "rgba(54, 162, 235, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao atualizar os dados:", error);
            alert("Erro ao processar os dados.");
        }
    }
</script>
{% endblock %}
